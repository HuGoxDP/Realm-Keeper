### План Разработки (Roadmap v0.2)

Этот план разбит на этапы, где каждый этап завершается работающим, тестируемым прототипом определенной системы. Мы будем использовать итеративный подход, наращивая сложность.

#### Этап 0: Подготовка и Архитектура (Неделя 0)

- **Цель:** Настроить архитектурный фундамент проекта.
- **Задачи:**
    1. Настроить Unity-проект с выбранными плагинами (Reflex, R3, etc.).
    2. Создать базовую сцену с террейном и источником света.
    3. Настроить DI-контейнер (Reflex) и создать основные сервисы-заглушки (`IGlobalResourceStorage`, `IVillagerManager`).
    4. Реализовать базовый RTS-контроллер камеры на Cinemachine.
- **Выход:** Проект с настроенной архитектурой, готовый к разработке геймплейных систем.

#### Этап 1: Прототип Жизненного Цикла Жителя (Неделя 1-2)

- **Цель:** Реализовать核心 механику жителей: рождение, состояние, смерть, перерождение.
- **Задачи:**
    1. Создать префаб `Villager` с базовой анимацией и `NavMeshAgent`.
    2. Реализовать `Hut` (Хижину): логику спауна жителя и отслеживания его статуса (жив/мертв). **Важно:** Использовать события или ReactiveProperties для связи.
    3. Реализовать простейшую State Machine для жителя: `IdleState`.
    4. Создать сервис `VillagerManager`, который регистрирует всех безработных жителей.
- **Выход:** На сцене можно разместить Хижину, она рождает жителя, который стоит в безработном состоянии. Если жителя уничтожить (через инспектор), Хижина со временем рождает нового.

#### Этап 2: Прототип Экономики и Работы (Неделя 3-4)

- **Цель:** Реализовать глобальное хранение ресурсов и систему назначения работы.
- **Задачи:**
    1. Реализовать сервис `GlobalResourceStorageService` (интерфейс `IGlobalResourceStorage`). Пока только для дерева.
    2. Создать префаб `LumberjackHut` (Домик дровосека). При построении он должен зарегистрировать запрос на работу в `VillagerManager`.
    3. Реализовать в `VillagerManager` логику сопоставления `IJob` (работа) из `LumberjackHut` с безработным `IVillager`.
    4. Реализовать для жителя состояния `MoveToWorkState` и `WorkState`. В `WorkState` житель должен просто "симулировать" работу (например, играть анимацию рубки).
    5. **Упрощение:** Пока ресурсы не добываются физически. Раз в N секунд `LumberjackHut` просто добавляет X дерева в `GlobalResourceStorage`.
- **Выход:** Игрок может построить Хижину и Домик дровосека. Житель автоматически назначается на работу и начинает "генерировать" ресурсы. Игрок видит рост числа ресурсов в UI.

#### Этап 3: Прототип Строительства и Защиты (Неделя 5)

- **Цель:** Реализовать систему размещения зданий и базовую защиту.
- **Задачи:**
    1. Реализовать `BuildingSystem`: выбор здания из UI, preview размещения, проверка на достаточность ресурсов (через `IGlobalResourceStorage`), окончательная установка.
    2. Добавить здания: `Storage` (Склад), который увеличивает `MaxCapacity` в `GlobalResourceStorageService`, и `Wall` (Стена).
    3. Реализовать компонент `Health` для зданий и систему нанесения урона.
- **Выход:** Игрок может тратить древесину на постройку Склада (увеличивает лимит) и Стен.

#### Этап 4: Прототип Врагов и Волн (Неделя 6)

- **Цель:** Реализовать угрозу, которую нужно сдерживать.
- **Задачи:**
    1. Создать префаб врага с `NavMeshAgent` и простым ИИ (цель - главное здание, атакует препятствия на пути).
    2. Реализовать `WaveManager`: спаунит волны врагов по таймеру или после окончания предыдущей волны.
    3. Реализовать индикатор скорой атаки (красную зону на краю карты).
- **Выход:** На базу периодически нападают волны врагов. Игрок должен строить стены, чтобы их сдержать.

#### Этап 5: Прототип Советников и Завершение MVP (Неделя 7)

- **Цель:** Реализовать систему прогрессии и награды за успешную оборону.
- **Задачи:**
    1. Реализовать UI экрана советников. После волны игроку предлагается **одна кнопка** с улучшением (например, "+10% урона башням").
    2. Создать `AdvisorService`, который хранит текущие активные улучшения и применяет их модификаторы.
    3. Связать улучшения с геймплеем (например, модификатор урона должен учитываться при расчете урона от башен).
    4. Объединить все системы в первый играбельный цикл: **Волна -> Выбор улучшения -> Строительство/Подготовка -> Новая волна**.
- **Выход:** **Минимально жизнеспособный продукт (MVP).** Игра с одним типом ресурса, одним типом врага, базовой системой жителей, строительства и улучшений.

---

### Архитектурные принципы для каждого этапа:

- **Этап 0:** **Принцип инверсии зависимостей (DIP).** Все сервисы зависят от абстракций (`IGlobalResourceStorage`), а не от конкретных реализаций.
- **Этап 1:** **Принцип единственной ответственности (SRP).** `Hut` отвечает только за спаун и отслеживание своего жителя. `VillagerManager` отвечает только за управление пулом.
- **Этап 2:** **Паттерн "Посредник" (Mediator).** `VillagerManager` выступает посредником между `LumberjackHut` и `Villager`, убирая прямые связи между ними.
- **Этап 3:** **Принцип открытости/закрытости (OCP).** `BuildingSystem` должен быть открыт для расширения (добавления новых зданий) но закрыт для модификаций.
- **Этап 4:** **Паттерн "Состояние" (State).** ИИ врага можно реализовать на простой стейт-машине (Patrol, Chase, Attack).
- **Этап 5:** **Паттерн "Наблюдатель" (Observer).** UI должен обновляться через подписку на ReactiveProperties из `GlobalResourceStorageService` и `WaveManager`.

Этот план фокусируется на создании прочного, расширяемого фундамента. После завершения MVP вы сможете легко добавлять новые типы ресурсов, зданий, врагов и усложнять систему советников, потому что архитектура будет это позволять.